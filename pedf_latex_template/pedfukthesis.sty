\ProvidesPackage{pedfukthesis}

% Use packages
\RequirePackage{kvoptions}
\RequirePackage{filecontents}
\RequirePackage{ifpdf}
\RequirePackage{etoolbox}
% This fixes pdfx package error
\RequirePackage[bookmarks,pdfencoding=auto]{hyperref}

% Options declaration

\SetupKeyvalOptions{
  family=pedfukthesis,
  prefix=pedfukthesis@
}

\DeclareStringOption{author}
\DeclareStringOption{title}
\DeclareStringOption{subject}
\DeclareStringOption{keywords}
\DeclareStringOption[Univerzita Karlova]{university}
\DeclareStringOption[Pedagogická fakulta]{faculty}
\DeclareStringOption{department}
\DeclareStringOption{programme}
\DeclareStringOption{field}
\DeclareStringOption[\the\year]{year}

% Theses types
\DeclareBoolOption{bachelor}
\DeclareBoolOption[true]{master}
\DeclareBoolOption{rigo}
\DeclareBoolOption{phd}
% use if a different value is required
\DeclareStringOption[\relax]{type}

% Apply the defult style. Set to false if you want to set page dimensions or
% line spacing yourself.


\DeclareBoolOption[true]{style}

\ProcessKeyvalOptions*

% Declare thesis type

% It is necessary to define two forms of the text
% One for the title page, second for the declaration

% Default text used in the declaration
\def\pedfukthesis@typedeclaration{práce}

\if\pedfukthesis@type\relax

  \ifpedfukthesis@master
  \def\pedfukthesis@type{Diplomová práce}
  \def\pedfukthesis@typedeclaration{diplomové práce}
  \fi
  
  \ifpedfukthesis@bachelor
  \def\pedfukthesis@type{Bakalářská práce}
  \def\pedfukthesis@typedeclaration{bakalářské práce}
  \fi
  
  \ifpedfukthesis@rigo
  \def\pedfukthesis@type{Rigorózní práce}
  \def\pedfukthesis@typedeclaration{rigorózní práce}
  \fi

  \ifpedfukthesis@phd
  \def\pedfukthesis@type{Disertační práce}
  \def\pedfukthesis@typedeclaration{disertační práce}
  \fi

\fi



% PDF/A compatibility

% Load PDF/A support only in the PDF mode
\ifpdf

  % write xmpdata
  \newwrite\xmpfile
  \openout\xmpfile=\jobname.xmpdata
  \write\xmpfile{\noexpand\Author{\pedfukthesis@author}}
  \write\xmpfile{\noexpand\Title{\pedfukthesis@title}}
  \write\xmpfile{\noexpand\Keywords{\pedfukthesis@keywords}}
  \write\xmpfile{\noexpand\Subject{\pedfukthesis@subject}}
  \write\xmpfile{\noexpand\Publisher{\pedfukthesis@university, \pedfukthesis@faculty}}
  \closeout\xmpfile
  
  % fix for pdfx and missing \pdfminorversion in LuaTeX
  \ifdefined\pdfminorversion\else
    \newcount\pdfminorversion
    \pdfminorversion=\pdfvariable minorversion
  \fi
  \RequirePackage[a-2u]{pdfx}
\fi


% set default style
\ifpedfukthesis@style
  % ugly parskip between is required. why, oh why?!!!
  \parskip=0.5em
  % prevent \mainmatter from page resetting
  % source: https://tex.stackexchange.com/a/380819/2891
  \renewcommand\frontmatter{%
    \cleardoublepage
    \@mainmatterfalse
    %\pagenumbering{roman}% Don't reset
  }
  \renewcommand\mainmatter{%
    \cleardoublepage
    \@mainmattertrue
    %\pagenumbering{arabic}% Don't reset
  }
\fi


% internal commands

\newcommand\pedfukthesis@printfield[1]{%
  \bgroup%
  \csuse{pedfukthesis@init@#1}%
  % declare default command to print the field it it isn't declared yet
  \csuse{pedfukthesis@#1}%
  \csuse{pedfukthesis@finish@#1}%
  \egroup%
}

% print field on a separate line
\newcommand\pedfukthesis@printfieldblock[1]{\noindent\pedfukthesis@printfield{#1}\par}

% #1 field name
% #2 commands executed at the beginning
% #3 command used to print the field string
% #4 commands executed after print
\newcommand\PedfDeclareFieldFormat[3]{%
  \csgdef{pedfukthesis@init@#1}{#2}%
  \csgdef{pedfukthesis@finish@#1}{#3}%
}

%
\newcommand\TitlePage[1][]{%
  \clearpage%
  \thispagestyle{empty}%
  \bgroup%
  % \parindent=0pt%
  \pedfukthesis@printfieldblock{university}%
  \pedfukthesis@printfieldblock{faculty}%
  \pedfukthesis@printfieldblock{department}%
  \pedfukthesis@printfieldblock{type}%
  \pedfukthesis@printfieldblock{title}%
  \pedfukthesis@printfieldblock{author}%
  \pedfukthesis@printfieldblock{keywords}%
  \egroup%
  \cleardoublepage%
}

% Default formatting

% \centering needs \par in the current group to take effect
\PedfDeclareFieldFormat{university}{\centering\large}{\par}
\PedfDeclareFieldFormat{faculty}{\centering\large}{\par\bigskip}
\PedfDeclareFieldFormat{department}{\centering}{\par\vfill}
\PedfDeclareFieldFormat{type}{\centering\large}{\par\vfill}
\PedfDeclareFieldFormat{title}{\centering\large}{\par}
\PedfDeclareFieldFormat{author}{}{}
\PedfDeclareFieldFormat{keywords}{}{}

\endinput
